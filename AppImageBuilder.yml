# appimage-builder recipe see https://appimage-builder.readthedocs.io for details
version: 1
AppDir:
  path: AppDir
  app_info:
    id: net.minetest.Minetest
    name: Minetest
    icon: minetest
    version: 5.6.1
    exec: usr/local/bin/minetest
    exec_args: $@
  files:
    include: []
    exclude:
    - usr/share/man
    - usr/share/doc
    - usr/share/lintian
  apt:
    arch: [amd64, i386]
    sources:
      - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse'
        key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920D1991BC93C'

    include:
    - libluajit-5.1-2
    - libopengl0
    - libgmpxx4ldbl
    - libpq5
    - libleveldb1d
    - libhiredis0.14
    - libjpeg-turbo8
    - libcurl4
    - libtinfo6
    - libncursesw6
    - libc6
AppImage:
  arch: x86_64
  update-information: guess
script: |
    # Remove any existent binaries
    rm -rf AppDir appimage-build | true

    # Compile and install binaries into AppDir
    # Minetest looks at usr/local/share for some reason
    cmake -B appimage-build -DCMAKE_INSTALL_PREFIX=AppDir/usr/local -DBUILD_SERVER=FALSE -DENABLE_GETTEXT=TRUE -DCMAKE_BUILD_TYPE=Release
    cmake --build appimage-build --parallel $(nproc) --config Release
    cmake --install appimage-build

    # Install irrlicht into AppDir
    wget -q "https://github.com/minetest/irrlicht/releases/download/$(cat misc/irrlichtmt_tag.txt)/ubuntu-bionic.tar.gz" -O appimage-build/irrlicht-ubuntu.tar.gz
    tar -xaf appimage-build/irrlicht-ubuntu.tar.gz -C AppDir/usr

    #mkdir AppDir/usr/local
    #cd AppDir
    #ln -s ../share usr/local/share
    #cd ../

    # Install the Minetest Game
    wget https://github.com/minetest/minetest_game/archive/5.6.1.tar.gz -O appimage-build/minetest_game.tar.gz
    cd appimage-build
    tar -xaf minetest_game.tar.gz
    cd ../
    mkdir -p AppDir/usr/local/share/minetest/games/minetest_game
    cp -r appimage-build/minetest_game-5.6.1/* AppDir/usr/local/share/minetest/games/minetest_game

    # Is a backup icon location instead of usr/share/local
    mkdir -p AppDir/usr/local/share/minetest/misc
    cp AppDir/usr/local/share/icons/hicolor/128x128/apps/minetest.png AppDir/usr/local/share/minetest/misc/minetest-xorg-icon-128.png
